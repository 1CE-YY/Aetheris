# 功能规格说明：学习资源检索与推荐 RAG 系统

**功能分支**：`001-rag-recommendation-system`
**创建日期**：2025-12-25
**状态**：草案
**输入描述**：面向高校学习场景的学习资源检索与推荐系统，提供资源入库管理、语义检索、基于 RAG 的问答、以及 Top-N 个性化推荐

## 用户场景与测试 *(必须)*

### 用户故事 1 - 资源入库与可追溯切片 (优先级: P1)

学生和管理员需要上传学习资源（PDF、Markdown 文档），系统自动提取文本、切片并保存定位信息，以便后续检索和引用。

**优先级理由**：这是整个系统的数据基础。没有资源入库，后续的语义检索、问答和推荐都无法进行。此功能可独立验证：用户上传资源后，能查看资源元数据和切片信息。

**独立测试**：可通过上传测试文档，验证资源元数据正确保存、文本成功提取、切片可定位（PDF 页码范围、Markdown 章节/段落），且切片数据可被后续检索使用。

**验收场景**：

1. **已知** 系统已就绪，用户已登录，**当** 用户上传一个 PDF 文档并填写标题、标签、描述，**则** 系统应在 **30秒内（P95）** 完成入库，显示成功消息，用户可在资源列表中查看该资源及其元数据
2. **已知** 一个 Markdown 文档已入库，**当** 用户查看资源详情，**则** 应显示文档标题、标签/课程方向、上传时间、文件类型、描述，以及切片列表（包含 chunkIndex、章节/段落信息或页码范围）
3. **已知** 用户上传了一个已存在的文件（基于内容哈希），**当** 系统检测到重复，**则** 应提示用户资源已存在，不创建重复记录或重复计算 Embedding

---

### 用户故事 2 - 语义检索与 RAG 问答 (优先级: P1)

学生输入自然语言问题，系统通过语义检索找到相关学习资源片段，并基于检索到的证据生成带引用来源的回答。

**优先级理由**：这是系统的核心价值功能——让学生"找得到、找得准、说得清"。语义检索解决"找得到"，RAG 问答解决"找得准、说得清"。此功能独立于个性化推荐，可单独测试和演示。

**独立测试**：可通过预设查询问题，验证系统返回的答案包含具体引用（resourceId、chunkId、chunkIndex、页码/范围、snippet），且答案内容基于检索到的证据片段，在证据不足时给出明确说明。

**验收场景**：

1. **已知** 系统中已有相关学习资源，用户已登录，**当** 用户在问答界面输入问题"什么是 RAG？"，**则** 系统应在 **5秒内（P95）** 返回答案，答案文本下方显示引用证据卡片（包含资源标题、页码/范围、相关文本摘录）
2. **已知** 系统中没有与问题相关的资源，**当** 用户输入问题，**则** 系统应明确说明"未找到相关学习资源"，并提供降级返回（如：显示系统中的候选资源列表或建议用户调整查询）
3. **已知** 系统检索到了部分相关证据，**当** 生成回答，**则** 答案必须严格基于检索到的证据，不得包含无法溯源的内容，每个关键论断都应标注引用来源

---

### 用户故事 3 - 个性化推荐 (优先级: P2)

基于用户的历史查询和交互行为，系统构建轻量用户画像，并据此推荐 Top-N 相关学习资源，每条推荐附带理由和证据引用。

**优先级理由**：推荐功能提升资源发现效率，但依赖用户行为数据积累。在 MVP 阶段可先实现基础画像（基于最近 N 次查询的滑动平均），后续迭代可扩展点击/收藏权重。此功能独立于核心问答流程，可在问答功能稳定后添加。

**独立测试**：可通过模拟用户历史查询（如最近 5 次查询关于"机器学习"），验证推荐列表包含相关资源，每条推荐显示推荐理由（如"基于您最近的查询兴趣"）和学习建议，并附带证据引用。

**验收场景**：

1. **已知** 用户最近查询了 5 次关于"深度学习"的问题，**当** 用户访问推荐页面，**则** 应显示 Top-N（如 Top-10）学习资源列表，每条资源包含标题、标签、推荐理由（如"根据您最近的查询兴趣"）、学习建议、以及相关证据片段
2. **已知** 用户点击了某个推荐资源，**当** 系统记录该行为，**则** 后续推荐应反映这一兴趣（点击行为权重为 2.0，高于查询行为的 1.0），用户画像应更新
3. **已知** 用户是新用户且无历史行为，**当** 访问推荐页面，**则** 应显示基于热门资源或默认推荐的列表，并提示"开始使用问答功能以获取个性化推荐"

---

### 用户故事 4 - 用户账户与行为记录 (优先级: P1)

用户需要注册账户、登录系统、维护基础信息，系统记录用户的查询和点击/收藏行为，用于构建画像和离线评测。

**优先级理由**：用户账户和行为记录是所有个性化功能的前提。行为数据也是评估系统效果（离线评测分析）的基础。此功能在 MVP 阶段必须实现，**MVP 阶段仅记录查询行为和点击行为，不实现收藏功能（收藏功能作为后续增强）**。

**独立测试**：可通过新用户注册流程验证账户创建、登录、信息修改，以及行为记录（查询后检查数据库或日志中存在行为记录，点击资源后记录更新）。

**验收场景**：

1. **已知** 用户是首次访问，**当** 用户完成注册流程（提供用户名、邮箱、密码），**则** 系统应创建账户，自动登录，跳转到主页面
2. **已知** 用户已登录，**当** 用户在问答界面提交问题，**则** 系统应记录该查询行为（包含用户 ID、查询文本、时间戳）
3. **已知** 用户已登录，**当** 用户点击或收藏某个资源，**则** 系统应记录该交互行为（包含用户 ID、资源 ID、行为类型、时间戳），并在推荐画像中反映此兴趣
4. **已知** 用户已登录，**当** 用户访问个人中心，**则** 应能查看和编辑基础信息（用户名、邮箱），并查看最近行为历史（查询记录、点击/收藏记录）

---

### 边界情况

- 当上传的 PDF 文件损坏或无法解析时，系统应提示用户文件格式错误或文件损坏，不进行后续处理
- 当上传的 Markdown 文件为空或仅包含空白字符时，系统应提示用户文件内容为空
- 当用户输入的问题超出合理长度（如超过 500 字符）时，系统应提示用户简化问题
- 当同时上传大量资源（如批量上传 100+ 文件）时，系统应提供进度反馈（**使用轮询机制，前端每 2 秒查询一次处理进度**），并在处理完成后通知用户
- 当语义检索未找到任何相关结果（相似度分数低于阈值）时，问答系统应明确告知用户未找到相关资源，并提供降级建议（如查看所有资源列表）
- 当 Embedding 或 LLM API 调用失败（网络错误、超时、配额用尽）时，系统应记录错误日志，并向用户显示友好的错误消息，避免暴露技术细节
- 当用户画像计算失败（如历史行为数据异常）时，推荐应回退到非个性化推荐（基于资源热度或随机），并记录错误
- 当离线评测数据集标注不一致（如同一查询有多个标注者给出不同相关资源列表）时，系统应记录标注差异，并在报告中说明

## 需求 *(必须)*

### 非功能需求

#### 性能要求

基于项目宪章"性能优先原则"，系统必须满足以下性能指标（以默认参数配置为准）：

- **资源入库性能**：单个中小型文档（≤10MB）的入库流程应在 **30秒内完成（P95）**，平均 **20秒**；系统必须记录并报告分阶段耗时（文本提取、切片、向量化、索引写入）
- **问答响应性能**：RAG 问答请求应在 **5秒内返回结果（P95）**，平均 **3秒**；当存在相关资源时，返回结果必须包含至少 1 条可验证引用
- **语义检索性能**：Top-K 向量检索应在 **1秒内完成（P95）**，平均 **0.5秒**
- **推荐生成性能**：Top-N 个性化推荐应在 **2秒内完成（P95）**，平均 **1.5秒**
- **并发性能**：系统应支持 **10-20 并发用户**同时进行问答请求，响应时间不应超过 P95 阈值的 150%

**性能预算阈值**（用于测试验收）：
- 资源入库：P95 ≤ 30秒，P99 ≤ 45秒
- 问答响应：P95 ≤ 5秒，P99 ≤ 8秒
- 语义检索：P95 ≤ 1秒，P99 ≤ 2秒
- 推荐生成：P95 ≤ 2秒，P99 ≤ 3秒

**性能监控要求**：
- 系统必须记录每个请求的总耗时和分段耗时（解析、Embedding、检索、生成）
- 性能指标必须输出到日志和监控系统，支持按时间窗口查询平均/P95/P99 时延
- 当性能超出预算阈值时，系统必须记录警告日志

#### 安全要求

- **密码策略**：用户密码必须至少 **8 位**，包含字母和数字；系统使用 BCrypt 算法进行哈希存储
- **认证令牌**：JWT token 有效期为 **24 小时**；token 过期后用户需重新登录
- **API 安全**：所有需要身份验证的 API 端点必须验证 JWT token；系统不得在日志中记录敏感信息（API key、密码、token 完整内容）
- **输入验证**：系统必须验证用户输入，防止注入攻击（SQL 注入、XSS 等）；查询文本长度限制为 **500 字符**

#### 可靠性要求

- **降级策略**：当 LLM 服务不可用或超时时，系统必须提供降级响应，不得返回空白失败；降级响应应包含检索到的 Top-5 切片结果、摘要和候选资源列表
- **缓存策略**：系统必须实现以下缓存以提升性能和降低成本：
  - Embedding 结果缓存：基于文本哈希，TTL **30 天**
  - 检索结果缓存：基于查询哈希+参数，TTL **1 小时**
  - 用户画像缓存：基于用户 ID，TTL **7 天**
- **幂等性**：资源入库必须幂等，相同内容（基于 SHA-256 哈希）的重复上传不得产生重复记录或重复计费

#### 可扩展性要求

- **参数可配置**：以下关键参数必须可通过配置文件调整，无需重新编译代码：
  - chunk 大小（默认 1000 字符）、chunk 重叠（默认 200 字符）
  - Top-K 检索数量（默认 5）、Top-N 推荐数量（默认 10）
  - Embedding 模型名称、Chat 模型名称
  - LLM 生成参数（temperature、top_p、max_tokens）
  - 用户画像窗口大小（默认 10 次查询）
  - 缓存 TTL 配置
- **多模型支持**：系统架构应支持切换不同的 Embedding 和 Chat 模型（通过配置文件，无需代码修改）

### 功能需求

- **FR-001**：系统必须支持用户注册、登录、登出，用户需提供用户名、邮箱、密码
- **FR-002**：系统必须允许用户维护基础信息（用户名、邮箱），支持查看和编辑
- **FR-003**：系统必须记录用户的查询行为，包含查询文本、时间戳、用户标识
- **FR-004**：系统必须支持用户对资源的点击或收藏行为（至少实现一种），记录行为类型、资源标识、时间戳
- **FR-005**：系统必须支持上传 Markdown 文档（.md 文件）和 PDF 文档（.pdf 文件）
- **FR-006**：系统必须维护资源元数据，包括：标题、标签/课程方向、上传时间、文件类型、可选描述
- **FR-007**：系统必须对上传的资源进行文本抽取（PDF 和 Markdown）、清洗（去除多余空白、特殊字符）、切片（按可配置的 chunk 大小和重叠参数）
- **FR-008**：系统必须为每个切片保存可追溯定位信息：PDF 切片保存页码范围，Markdown 切片保存章节/段落信息或 chunkIndex
- **FR-009**：系统必须将每个切片向量化并写入向量索引（用于语义检索）
- **FR-010**：系统必须支持基于自然语言查询的语义检索，返回 Top-K 最相关的切片（K 值可配置）
- **FR-011**：系统必须支持将切片聚合到资源级别（用于推荐列表和展示，按资源聚合相关切片）
- **FR-012**：系统必须允许配置关键参数：chunk 大小（token 数）、chunk 重叠（token 数）、Top-K 检索数量、Embedding 模型选择、LLM 生成参数（temperature、max_tokens）
- **FR-013**：系统必须提供 RAG 问答功能：用户输入问题后，先进行语义检索召回 Top-K 证据切片，再基于这些切片生成答案
- **FR-014**：系统必须确保所有 AI 生成的答案包含引用来源，每个引用包含：resourceId、chunkId、chunkIndex、页码/范围、snippet（支持该答案的文本摘录）
**引用（Citations）结构规范（必须）**  
系统对外返回的 citations 应使用稳定 JSON 结构，至少包含：
- resourceId, resourceTitle
- chunkId, chunkIndex
- location：PDF 用 pageStart/pageEnd；Markdown 用 heading/section 或等价定位信息
- snippet：用于支撑结论的原文摘录（长度可截断）
- **FR-015**：系统必须在检索证据不足时（如未找到相关切片或相似度分数过低）给出明确说明，并提供**降级返回**（**不得返回空白失败**）：返回检索到的 Top-5 候选切片结果、证据摘要（每个切片的标题和 snippet）、以及候选资源列表
- **FR-016**：系统必须构建**轻量用户画像**：基于用户最近 **N 次查询（默认 10 次）** 的 Embedding 向量进行滑动平均，生成用户兴趣向量；不依赖复杂的深度学习模型训练
- **FR-017（可选增强）**：系统可支持在画像计算中加入点击/收藏行为权重（可配置开关与权重值）；**点击权重建议 2.0，收藏权重建议 3.0（查询权重为 1.0）**；MVP 可先仅基于查询行为构建画像。
- **FR-018**：系统必须提供个性化推荐：使用画像向量（或画像+当前查询）召回候选切片，聚合到资源级别，输出 Top-N 推荐列表（N 可配置）
- **FR-019**：系统必须为每条推荐提供推荐理由（如"基于您最近的查询兴趣"、"与您收藏的《XXX》相关"）和学习建议（如"建议先学习第 3 章内容"）
- **FR-020**：系统必须为推荐理由提供证据引用（格式同 FR-014 定义的问答引用规范：包含 resourceId、resourceTitle、chunkId、chunkIndex、location、snippet）
- **FR-021**：系统必须支持**小规模离线测试集管理（50-100 个测试查询）**：人工设计查询问题并标注相关资源列表（每个查询对应 1-N 个相关资源）
说明：离线测试集管理的实现形式不限定为 UI，可采用 JSON/YAML 文件 + 后端运行接口/命令行方式，保证可版本化与可重复运行即可。
- **FR-022**：系统必须对语义检索计算评价指标：Precision@K（K 值可配置，如 K=5,10）、Recall@K
- **FR-023**：系统必须对比两种推荐策略的性能指标：无画像（仅基于当前查询）vs 有画像（基于用户画像），输出指标差异（Precision@K、Recall@K）
- **FR-024**：系统必须记录并报告系统响应时延：平均响应时间、TP95 或近似 P95 时延（用于评估系统可用性）
- **FR-025**：系统必须支持可重复的参数对比实验：记录每次实验的参数配置（chunk 大小、TopK 等）和对应的性能指标，以便复现

### 关键实体

- **用户 (User)**：系统使用者，包含属性：用户 ID、用户名、邮箱、密码哈希、注册时间、最近行为时间戳
- **学习资源 (Resource)**：上传的文档，包含属性：资源 ID、标题、标签/课程方向、上传时间、文件类型（PDF/Markdown）、描述、文件存储路径、内容哈希（用于去重）
- **资源切片 (Chunk)**：文档切分后的文本片段，包含属性：切片 ID、资源 ID（外键）、切片文本内容、chunkIndex（在文档中的位置）、定位信息（PDF 页码范围或 Markdown 章节/段落）、向量化状态（是否已嵌入 Embedding）
- **用户行为 (UserBehavior)**：统一的行为记录表，包含查询、点击、收藏三种行为类型，属性包括：行为 ID、用户 ID（外键）、行为类型（QUERY/CLICK/FAVORITE）、资源 ID（外键，CLICK/FAVORITE 行为有值）、查询文本（QUERY 行为有值）、行为时间戳、**session_id（会话标识，用于行为分析，不用于会话状态管理）**、权重（可选，用于画像计算，查询权重 1.0、点击权重 2.0、收藏权重 3.0）
- **用户画像 (UserProfile)**：用户兴趣模型，包含属性：画像 ID、用户 ID（外键）、兴趣向量（Embedding 表示）、更新时间、行为窗口大小 N
- **检索结果 (SearchResult)**：语义检索的切片结果，包含属性：结果 ID、切片 ID（外键）、相似度分数、检索时间戳
- **引用来源 (Citation)**：答案或推荐的证据引用，包含属性：引用 ID、资源 ID（外键）、切片 ID（外键）、chunkIndex、页码/范围、snippet（文本摘录）
- **测试查询 (TestQuery)**：离线评测的测试查询，包含属性：查询 ID、查询文本、标注的相关资源 ID 列表、查询创建时间
- **实验记录 (ExperimentRecord)**：参数对比实验记录，包含属性：实验 ID、实验名称、参数配置（chunk 大小、TopK、Embedding 模型等）、性能指标（Precision@K、Recall@K、平均时延、P95 时延）、实验时间戳

## 成功标准 *(必须)*

### 可衡量成果（以指定测试环境与参数为准）

- **SC-001（目标）**：在指定测试环境与默认参数（chunkSize、TopK）下，单个中小型文档（如 ≤10MB）的入库流程可完成，并记录分阶段耗时（解析/切片/Embedding/写入索引）。
- **SC-002（目标）**：问答请求可在 **5秒内（P95）**、**平均 3秒内**返回结果，并记录总耗时与分段耗时；当存在相关资源时，返回结果包含至少 1 条可验证引用（citations）。
- **SC-003（必须）**：系统支持对离线测试集计算并输出语义检索指标：Precision@K、Recall@K（K 可配置），并保存每次运行的参数与结果以便复现。
- **SC-004（必须）**：系统支持对比两种推荐策略：无画像（仅 query）与有画像（用户画像），输出对比指标与差异结论（不强制固定提升阈值，但必须可复现）。
- **SC-005（必须）**：所有答案与推荐的引用来源 100% 可定位：可跳转到资源详情并展示对应 chunk 文本与位置信息（页码/章节/序号）。
- **SC-006（必须）**：系统输出基础性能统计（平均/近似 p95 或 p95），用于论文与调参分析；不在规格阶段硬性锁定数值阈值。

## 非目标

本功能范围明确排除以下内容，以避免范围膨胀：

- **不做微服务拆分**：不使用 Spring Cloud 或其他微服务框架，保持 Spring Boot 单体应用架构
- **不做在线 A/B 实验平台**：不支持在线实时对比不同算法策略的 A/B 测试，所有评测基于离线数据集
- **不做大规模协同过滤**：不依赖大量用户行为数据训练复杂的协同过滤或矩阵分解模型，仅使用轻量画像（基于最近 N 次行为的滑动平均）
- **不做高风险生成功能**：不实现"自动生成教材内容"、"整课内容生成"等大规模生成式功能，仅提供基于证据的问答和推荐理由
- **不做复杂权限管理**：MVP 阶段不区分管理员/学生角色，所有登录用户具备相同功能；后续如需扩展再引入角色权限。
- **不做社交功能**：不支持资源分享、评论、点赞等社交互动功能
- **不做多语言支持**：界面和内容仅支持中文（英文资源可作为内容处理，但界面不本地化）
- **不做实时通知**：不支持邮件通知、站内消息推送等通知功能

## 假设与依赖

### 假设

- 用户使用现代浏览器（Chrome、Firefox、Safari、Edge 的最新版本）访问系统
- 上传的学习资源为合法、非侵权内容
- 用户行为数据（查询、点击、收藏）可用于构建用户画像和离线评测，符合隐私保护要求
- Embedding 和 LLM API 服务稳定可用，系统可通过网络访问这些服务
- 单个资源文档大小不超过 50MB（PDF 或 Markdown）
- 系统部署环境支持运行 Spring Boot 应用和向量数据库（Redis Stack）
- 离线测试集由人工标注，标注者具备相关领域知识，能准确判断资源相关性
- 用户画像采用简单的滑动平均或加权平均方法，无需复杂的深度学习模型训练

### 依赖

- 外部 Embedding API 服务（用于文本向量化）
- 外部 LLM API 服务（用于答案生成和推荐理由生成）
- Redis Stack（用于向量存储和检索）
- MySQL 或其他关系数据库（用于存储结构化数据：用户、资源、行为记录等）
- 文本解析库（PDF 解析库如 Apache PDFBox，Markdown 解析库）
- 前端框架和构建工具（用于实现用户界面）

## 范围边界

### 包含范围

- 用户账户管理（注册、登录、信息维护）
- 学习资源上传（Markdown、PDF）和元数据管理
- 文本提取、切片、向量化入库
- 语义检索（Top-K 相关切片）
- RAG 问答（基于检索证据生成带引用答案）
- 用户行为记录（查询、点击/收藏）
- 轻量用户画像（基于最近 N 次行为）
- 个性化推荐（Top-N 资源列表，附带理由和证据）
- 离线测试集管理和评价（Precision@K、Recall@K、时延统计）
- 参数可配置和可复现实验

### 不包含范围

- 视频资源、音频资源、图片资源（仅支持 PDF 和 Markdown 文本文档）
- 复杂的权限管理和多角色系统
- 在线 A/B 实验平台
- 社交功能（分享、评论、点赞）
- 邮件通知、站内消息推送
- 多语言界面
- 大规模协同过滤算法或矩阵分解
- 自动生成教材或课程内容
- 微服务架构

## 附录

### 术语表

- **RAG (Retrieval-Augmented Generation)**：检索增强生成，一种结合信息检索和生成式 AI 的技术，先检索相关文档，再基于检索结果生成答案
- **Embedding**：文本向量化，将文本转换为数值向量的表示，用于计算语义相似度
- **Chunk**：文本切片，将长文档切分为较小的文本片段，便于向量化与检索
- **Top-K**：检索或推荐中返回的前 K 个最相关结果
- **Precision@K**：精确率指标，表示 Top-K 结果中相关结果所占比例
- **Recall@K**：召回率指标，表示 Top-K 结果召回了多少比例的相关项
- **P95 时延**：95% 的请求的响应时间上限，用于评估系统性能稳定性
- **滑动平均**：一种计算用户画像的方法，对最近的 N 次行为计算平均向量，旧行为随着新行为加入逐渐被替换
- **TP95**：第 95 百分位响应时间，与 P95 含义相同

### 用户界面原型要点

- **问答界面**：输入框 + 提交按钮 → 显示答案文本 + 下方引用证据卡片列表（每个卡片显示资源标题、页码/范围、文本摘录、可点击跳转到资源详情）
- **推荐界面**：Top-N 资源列表，每个资源卡片显示标题、标签、推荐理由（文本说明）、学习建议（简要步骤）、相关证据引用、收藏按钮
- **资源详情页面**：显示资源元数据（标题、标签、上传时间、描述、文件类型）、切片列表（每个切片显示 chunkIndex、定位信息、文本预览、可复制文本）
- **资源上传界面**：文件选择器（支持 PDF 和 Markdown）、标题输入框、标签输入框（支持多个标签）、描述文本框、上传按钮、进度提示
- **个人中心**：显示用户信息（用户名、邮箱，可编辑）、最近行为历史（查询记录列表、点击/收藏记录列表）

### 评价指标计算公式

- **Precision@K** = (Top-K 结果中的相关资源数量) / K
- **Recall@K** = (Top-K 结果中的相关资源数量) / (测试集中标注的相关资源总数)
- **平均响应时间** = 所有请求响应时间的总和 / 请求总数
- **P95 响应时间** = 将所有请求响应时间从小到大排序，取第 95 百分位的值
- **有画像 vs 无画像 Precision 提升** = (Precision@K_有画像 - Precision@K_无画像) / Precision@K_无画像 × 100%
